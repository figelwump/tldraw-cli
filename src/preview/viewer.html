<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>tldraw-cli preview</title>
    <link rel="stylesheet" href="/tldraw.css" />
    <style>
      :root {
        --bg: #f3f5f8;
        --panel: #ffffff;
        --line: #d9dee5;
        --ink: #1b2638;
        --muted: #5f6f85;
        --accent: #0d7a6e;
        --danger: #b42318;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        color: var(--ink);
        background: var(--bg);
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      }

      .topbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 14px;
        border-bottom: 1px solid var(--line);
        background: color-mix(in oklab, var(--panel) 85%, transparent);
        backdrop-filter: blur(6px);
      }

      .topbar-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .title {
        font-family: "Space Grotesk", "Avenir Next", sans-serif;
        font-size: 15px;
        letter-spacing: 0.03em;
        text-transform: uppercase;
      }

      .status {
        font-size: 13px;
        color: var(--muted);
      }

      .status.error {
        color: var(--danger);
      }

      .json-toggle-btn {
        border: 1px solid var(--line);
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        color: var(--ink);
        background: var(--panel);
        font-family: "IBM Plex Mono", "SF Mono", monospace;
      }

      .json-toggle-btn:hover {
        background: var(--bg);
      }

      .json-toggle-btn.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      #tldraw-root {
        position: absolute;
        inset: 0;
        top: 42px;
      }

      .json-sidebar {
        position: fixed;
        top: 42px;
        right: 0;
        bottom: 0;
        width: min(480px, 45vw);
        z-index: 999;
        background: var(--panel);
        border-left: 1px solid var(--line);
        box-shadow: -4px 0 20px rgba(16, 24, 40, 0.08);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.2s ease;
      }

      .json-sidebar.visible {
        transform: translateX(0);
      }

      .json-sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid var(--line);
        font-size: 12px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .json-close-btn {
        border: none;
        background: none;
        cursor: pointer;
        font-size: 18px;
        color: var(--muted);
        padding: 2px 6px;
        border-radius: 4px;
      }

      .json-close-btn:hover {
        background: var(--bg);
        color: var(--ink);
      }

      #json-content {
        flex: 1;
        overflow: auto;
        padding: 12px;
        margin: 0;
        font-size: 11px;
        line-height: 1.55;
        font-family: "IBM Plex Mono", "SF Mono", monospace;
        color: #0f1728;
        white-space: pre-wrap;
        word-break: break-all;
      }

      #loading-message {
        position: absolute;
        inset: 0;
        top: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        color: var(--muted);
      }
    </style>
    <!-- tldraw + React loaded from local bundle to avoid dual-React-instance
         issues that occur with CDN loading (esm.sh resolves transitive
         deps to different React versions). -->
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-left">
        <div class="title">tldraw-cli</div>
        <div id="status" class="status">Loading editor…</div>
      </div>
      <button id="json-toggle" class="json-toggle-btn" type="button">{ } JSON</button>
    </header>

    <div id="loading-message">Loading tldraw editor…</div>
    <div id="tldraw-root"></div>

    <aside id="json-sidebar" class="json-sidebar">
      <div class="json-sidebar-header">
        <span>Document JSON</span>
        <button id="json-close" class="json-close-btn" type="button">&times;</button>
      </div>
      <pre id="json-content"></pre>
    </aside>

    <!--__TLDRAW_PREVIEW_CONFIG__-->

    <!-- Fallback: if tldraw hasn't mounted after 10s, show error -->
    <script>
      window.__loadCheck = setTimeout(function () {
        var root = document.getElementById('tldraw-root');
        if (root && root.children.length === 0) {
          var msg = document.getElementById('loading-message');
          if (msg) {
            msg.textContent = 'Failed to load tldraw editor. Try reloading the page.';
          }
        }
      }, 10000);
    </script>

    <script type="module">
      const config = window.__TLDRAW_PREVIEW_CONFIG__ ?? { readonly: false };
      const statusEl = document.getElementById('status');
      const jsonToggleBtn = document.getElementById('json-toggle');
      const jsonSidebar = document.getElementById('json-sidebar');
      const jsonCloseBtn = document.getElementById('json-close');
      const jsonContent = document.getElementById('json-content');
      const loadingMessage = document.getElementById('loading-message');

      let socket = null;
      let editor = null;
      let debounceHandle = null;
      let reconnectDelayMs = 1000;
      // Buffer first document message if it arrives before editor mounts
      let pendingDocument = null;
      // Track the file format version from the server so saves preserve it
      let fileFormatVersion = 1;

      function setStatus(text, isError = false) {
        statusEl.textContent = text;
        statusEl.classList.toggle('error', isError);
      }

      // -- JSON sidebar toggle --
      let jsonVisible = false;
      function toggleJson(force) {
        jsonVisible = force !== undefined ? force : !jsonVisible;
        jsonSidebar.classList.toggle('visible', jsonVisible);
        jsonToggleBtn.classList.toggle('active', jsonVisible);
        if (jsonVisible) updateJsonPanel();
      }
      jsonToggleBtn.addEventListener('click', () => toggleJson());
      jsonCloseBtn.addEventListener('click', () => toggleJson(false));

      // Record types that belong in the .tldr file (document scope).
      // Session records (camera, instance, page_state, pointer) stay local.
      const DOCUMENT_TYPES = new Set(['asset', 'binding', 'document', 'page', 'shape']);

      function updateJsonPanel() {
        if (!jsonVisible || !editor) return;
        try {
          const fileDoc = storeToFileDoc();
          jsonContent.textContent = JSON.stringify(fileDoc, null, 2);
        } catch {
          // Editor may not be ready yet
        }
      }

      // -- Build .tldr file document from editor store --
      function storeToFileDoc() {
        const records = editor.store.allRecords()
          .filter(r => DOCUMENT_TYPES.has(r.typeName));
        return {
          tldrawFileFormatVersion: fileFormatVersion,
          records,
          schema: editor.store.schema.serialize()
        };
      }

      // -- Save: editor → server --
      function sendSave() {
        if (config.readonly || !socket || socket.readyState !== WebSocket.OPEN || !editor) {
          return;
        }

        try {
          const fileDoc = storeToFileDoc();
          socket.send(JSON.stringify({ type: 'save', document: fileDoc }));
          setStatus('Saving…');
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          setStatus(`Save error: ${message}`, true);
        }
      }

      // -- Apply document from server into editor --
      // Uses incremental put/remove so tldraw's session records
      // (camera, instance, page state) remain intact.
      function applyDocument(document) {
        if (document.tldrawFileFormatVersion) {
          fileFormatVersion = document.tldrawFileFormatVersion;
        }

        if (!editor) {
          pendingDocument = document;
          return;
        }

        try {
          const incomingRecords = document.records;
          const incomingIds = new Set(incomingRecords.map(r => r.id));

          editor.store.mergeRemoteChanges(() => {
            // Remove document-scope records absent from the incoming set
            const toRemove = editor.store.allRecords()
              .filter(r => DOCUMENT_TYPES.has(r.typeName) && !incomingIds.has(r.id))
              .map(r => r.id);
            if (toRemove.length > 0) editor.store.remove(toRemove);

            // Add/update all incoming records
            editor.store.put(incomingRecords);
          });
          if (jsonVisible) updateJsonPanel();
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          setStatus(`Sync error: ${message}`, true);
        }
      }

      // -- WebSocket connection --
      function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        socket = new WebSocket(`${protocol}//${window.location.host}/ws`);

        socket.addEventListener('open', () => {
          reconnectDelayMs = 1000;
          setStatus('Connected');
        });

        socket.addEventListener('close', () => {
          setStatus(`Disconnected. Retrying in ${Math.round(reconnectDelayMs / 1000)}s…`, true);
          window.setTimeout(connect, reconnectDelayMs);
          reconnectDelayMs = Math.min(reconnectDelayMs * 2, 30000);
        });

        socket.addEventListener('message', (event) => {
          try {
            const message = JSON.parse(event.data);

            if (message.type === 'document') {
              applyDocument(message.document);
              setStatus(message.readonly ? 'Connected (readonly)' : 'Connected');
              return;
            }

            if (message.type === 'saved') {
              setStatus('Saved');
              return;
            }

            if (message.type === 'error') {
              setStatus(message.message, true);
              return;
            }
          } catch (error) {
            const message = error instanceof Error ? error.message : String(error);
            setStatus(`Message error: ${message}`, true);
          }
        });
      }

      // -- Mount tldraw editor --
      async function mountEditor() {
        // Dynamic import so we get tldraw from the import map
        const { createRoot, jsx, Tldraw } = await import('/tldraw-bundle.js');

        // Clear loading message
        if (loadingMessage) loadingMessage.remove();
        clearTimeout(window.__loadCheck);

        const root = createRoot(document.getElementById('tldraw-root'));

        root.render(
          jsx(Tldraw, {
            onMount: (editorInstance) => {
              editor = editorInstance;

              if (config.readonly) {
                editor.updateInstanceState({ isReadonly: true });
              }

              // Apply buffered document if server sent it before mount
              if (pendingDocument) {
                applyDocument(pendingDocument);
                pendingDocument = null;
              }

              // Listen for user edits and auto-save (skip in readonly)
              if (!config.readonly) {
                editor.store.listen(
                  () => {
                    if (debounceHandle) window.clearTimeout(debounceHandle);
                    debounceHandle = window.setTimeout(sendSave, 700);
                  },
                  { source: 'user', scope: 'document' }
                );
              }

              // Update JSON panel when store changes (any source)
              editor.store.listen(
                () => {
                  if (jsonVisible) updateJsonPanel();
                },
                { scope: 'document' }
              );
            }
          })
        );
      }

      // Start everything
      connect();
      mountEditor().catch((error) => {
        console.error('Failed to mount tldraw editor:', error);
        if (loadingMessage) {
          loadingMessage.textContent = 'Failed to load tldraw editor: ' + (error.message || String(error));
        }
      });
    </script>
  </body>
</html>
